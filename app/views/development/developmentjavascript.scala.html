<script type="text/javascript" >
	$(document).ready(function(){

		mouseCheck();
		
		$(document).on('click', '.btn-success', function(event){
	
	    	var name = $('#name').val();
	    	var title = $('#title').val();
	    	var description = $('#description').val();
	    	//alert( name + title + description );
	    	
	    	var route = r = jsRoutes.controllers.Development.validatePage(name).ajax({
	    		beforeSend: function() {
	    			$('#modalNew').find('.modal-loading').show();
	    			$('#modalNew').find('.modal-form').hide();
	    		},
	    		success: 	function(data) {
					if (data != null && data != '')
					{
						$('#modalNew').find('.modal-error').css('padding-left', '15px');
						$('#modalNew').find('.modal-error').css('padding-right', '15px');
						$('#modalNew').find('.modal-error').html("<div class='alert alert-danger'>" + data + "</div>");
		    			$('#modalNew').find('.modal-loading').hide();
		    			$('#modalNew').find('.modal-form').show();
					}
					else
					{
				    	jsRoutes.controllers.Development.addPage(name, title, description).ajax({
							success: function(data) {
								//alert(data)
						    	//$('#result').html(data);

						    	window.setTimeout(function(){
						    		window.location.replace("/development/" + name);
						        }, 5000);

								
						  	},
						  	error: function() {
				    			$('#modalNew').find('.modal-loading').hide();
				    			$('#modalNew').find('.modal-form').show();						  		
						    	alert("Error!");
						  	}
						});
					}
				},
				error:		function(){
					alert("Error!");
				}
	    	});
	    	

	    	
		});
	
		$(document).on('click', '#open-menu', function(event){
	
	    	jsRoutes.controllers.Development.openMenu().ajax({
	    		success: function(data) {
					//alert(data);
					
					$('#open-result').html(data);			    				    	
			  	},
			  	error: function() {
			    	alert("Error!")
			  	}
			});
	    	
		});

	    $('input[type=file]').change(function() {
			var file = this.files[0];
			uploadFile(file);
	    });
	
		if (Modernizr.draganddrop) 
		{
			// Browser supports HTML5 DnD.
		  	//alert("drag and drop");
		} 
		else 
		{
		  	// Fallback to a library solution.
			//alert("no drag and drop");
		}
		
  		// Setup the dnd listeners.
  		var dropZone = document.getElementById('drop-zone');
  		dropZone.addEventListener('dragover', handleDragOver, false);
  		dropZone.addEventListener('drop', handleFileSelect, false);

		mediaThumbnails();

		setDroppable();
		
		draggableTemplate();
		
		editText();
					
	});
	
	//Functions
    function uploadFile(file)
    {
		//this only uploads raw file
    	var route = r = jsRoutes.controllers.Development.uploadAjax(file.name).ajax({
	    	data: file,
	    	processData: false,
            contentType: false,
            cache: false,
            type: 'POST',
			success: function(data) {
				mediaThumbnails();
		  	},
		  	error: function() {
		    	alert("Error!");
		  	}
		});	    
    }
	
	function mediaThumbnails(){
		var route = r = jsRoutes.controllers.Development.showImageThumbnails("medium").ajax({
			success: function(data) {
				//alert(data);
		    	$('#media-thumbnails').html(data);
		    	draggableThumbnail();
		  	},
		  	error: function() {
		    	alert("Error!");
		  	}
		});
	}


	
	function updateComponent(element)
	{
		var childIds = [];
		var componentType = $(element).attr('type');
		var classes = $(element).attr('class');
		var code = "";
		var componentId = 0;
		var displayOrder = $(element).index();
		
		var parent = $(element).parent().closest('.component-element, .custom-page');
		var parentId = $(parent).attr('id');

		if ($(element).attr('id'))
		{
			componentId = $(element).attr('id');
		}

		if (componentType != "row" && componentType != "column")
		{
			code = $(element).html();
		}
		
		if ($(parent).hasClass('custom-page'))
		{
			jsRoutes.controllers.Development.updateTopLevelComponent(componentId, parentId, componentType, classes, code, displayOrder).ajax({
				async: false,
				success: function(data) 
				{
					//alert("data: " + data);
		    		componentId = data;					    											    						    	
			  	},
			  	error: function() 
			  	{
			    	alert("Error!");
			  	}
			});	
		}
		else
		{
			jsRoutes.controllers.Development.updateComponent(componentId, parentId, componentType, classes, code, displayOrder).ajax({
				async: false,
				success: function(data) 
				{
		    		componentId = data;					    											    						    	
			  	},
			  	error: function() 
			  	{
			    	alert("Error!");
			  	}
			});		
		}
		
		$(element).attr('id', componentId);
		
		$(element).find('.component-element').each(function(index, value){
			childIds.push( updateComponent(value) );
		});
		
		return componentId;		
	}

	function updateOrder(element)
	{
		var parentType = "component";
		var parentId = $(element).attr('id');
		var order = $(element).sortable('toArray');

		if ($(element).hasClass('custom-page'))
		{
			parentType = "page";
		}

		jsRoutes.controllers.Development.updateOrder(parentType, parentId, order).ajax({
			async: false,
			success: function(data) 
			{
		  	},
		  	error: function() 
		  	{
		    	alert("Error!");
		  	}
		});		
	}
	
	function setDroppable()
	{
		var id = 5;
		var testItem;
		
		$(".custom-page, .custom-page .column").sortable({
			placeholder: "test-row-clone",
	        connectWith: ".column",
            revert:			true,
	        opacity: .50,
	        beforeStop: function(event, ui)
	        {
	        	testItem = ui.item;
	        },
	        receive: function(event, ui)
	        {
	        	updateComponent(testItem);
	        },
	        update: function(event, ui)
	        {
	        	if (this === ui.item.parent()[0]) 
	        	{
		        	updateOrder(this);
				}
	        }
	        //handle: ".drag"
	    });
	    $(".sidebar-nav .component-wrapper").draggable({
	        connectToSortable: ".custom-page",
	        helper: "clone",
	        stop: function (event, ui) 
	        {
	            $(".custom-page .column").sortable({
	    			placeholder: "test-row-clone",
	    	        connectWith: ".column",
	    	        opacity: .50,
	    	        beforeStop: function(event, ui)
	    	        {
	    	        	testItem = ui.item;
	    	        },
	    	        receive: function(event, ui)
	    	        {
	    	        	updateComponent(testItem); 	        
    	        	},
    		        update: function(event, ui)
    		        {
    		        	if (this === ui.item.parent()[0]) 
       		        	{
    			        	updateOrder(this);
    					}
    		        }
	            });
	        }
	    });
	    $(".sidebar-nav .design-element").draggable({
	        connectToSortable: ".column",
	        helper: "clone",
	        //handle: ".drag",
	        drag: function (event, ui) {
	            ui.helper.width(500)
	        }
	    });
	}
	
	function draggableTemplate()
	{
		$('.template-wrapper').each( function(index, event) {
			if ($(event).attr('id'))
			{

				$(event).draggable({
		            helper:         'original',
		            containment:    '.custom-page',
		            tolerance:      'fit',
		            cursor:         'move',
		            snap:			'.grid-cell',
		            start: function(event, ui){
		            	if ($(this).data('droppable'))
	            		{
			            	$(this).droppable( 'disable' );	            		
	            		}
		            },
		            stop: function(event, ui){
		            	if ($(this).data('droppable'))
	            		{
			            	$(this).droppable( 'enable' );	            		
	            		}
		            }
		        });

				$(event).find('div.component-wrapper > ul.nav').each( function(index, e) {
					
					var parentElement = e;

					//$('#test-msg').html($(hoverElement).attr('id'));
					
					$(parentElement).droppable({
						greedy: true,
						hoverClass: 'Phil-Test',
						activate: function(event, ui){
							$('#test-msg').html("top: " + ui.position.top + ", left: " + ui.position.left);
						},
						//accept: '.template-wrapper',
						scope: 'menu-element',	
						drop: function(event, ui){
							//$(parentElement).addClass('Phil-Test');
							alert("Drop test");
						}
					});
				});
				
			}
        });
	}
	//recursive test function
	function test(elem)
	{
	    $(elem).children('.component-wrapper').each(function(){
	        //alert('test');
	        test($(this));
	    });
	}

	test($('body'));
	
	function draggableThumbnail()
	{
        $('.draggable-thumbnail').draggable({
            helper:			function(event){
				var result = $(this).clone();

				//alert($(result).find('img').attr('parentId'));
				
				var img = $(result).find('img');
            	
			 	var route = r = jsRoutes.controllers.Development.getImage(img.attr('parentId'), "large").ajax({
					success: function(data) {

						
						//alert(data);
						img.replaceWith(data);
			    		//$(result).html(data);					    	
				  	},
				  	error: function() {
				    	alert("Error!");
				  	}
				});
				
				return $(result);		            
            },
            containment:    ".custom-page",
            tolerance:      "fit",
            cursor:         "move",
            revert:			true,
            snap:			".col-xs-1",
            /**
            drag: function( event, ui ) {
                var snapTolerance = $(this).draggable('option', 'snapTolerance');
                var topRemainder = ui.position.top % 68;
                var leftRemainder = ui.position.left % 63;
                
                if (topRemainder <= snapTolerance) {
                    ui.position.top = ui.position.top - topRemainder;
                }
                
                if (leftRemainder <= snapTolerance) {
                    ui.position.left = ui.position.left - leftRemainder;
                }
            }, 
            /**/
            start:  function( event, ui ){
                //zIndexTemp = $(this).zIndex();
                //$(this).zIndex( 9999 );
            },
            stop:   function( event, ui ){
                //zIndexTemp = $(this).zIndex();
                //$(this).zIndex( zIndexTemp );
            }

        });
    }
	
	function handleDragOver(event) 
	{
   		event.stopPropagation();
   		event.preventDefault();
   		event.dataTransfer.dropEffect = 'copy'; // Explicitly show this is a copy.
	}
		
	function handleFileSelect(event) 
	{
		event.stopPropagation();
  		event.preventDefault();

  		var files = event.dataTransfer.files; // FileList object.

  		// files is a FileList of File objects. List some properties.
  		
  		var output = [];
  		
  		for (var i = 0, f; f = files[i]; i++) 
  		{
   			uploadFile(f);
   			
   			output.push('<li><strong>', escape(f.name), '</strong> (', f.type || 'n/a', ') - ',
         			f.size, ' bytes, last modified: ',
               	f.lastModifiedDate ? f.lastModifiedDate.toLocaleDateString() : 'n/a',
               	'</li>');
		}
 			
  		document.getElementById('list').innerHTML = '<ul>' + output.join('') + '</ul>';
	}

	
	function editText()
	{

		$('.editable-text').popline();
		$('.editable-text').mouseenter(function() 
		{
			$(this).parents('.ui-draggable').draggable('disable');
			//alet('mouse enter');
		});
		
		$('.editable-text').mouseleave(function() 
		{
			$(this).parents('.ui-draggable').draggable('enable');
		});		

	}

	function mouseCheck()
	{
		$('*').on('mouseenter', function() { 
			var hoverElement = this; 
			var navElement = $(hoverElement).children('div.component-wrapper > ul.nav');
			//$(hoverElement).find('div.component-wrapper > ul.nav').each(function()
			//{
				//alert("PHIL TEST");
				//$(hoverElement).append("test").stop();
				
				//$('#test-msg').html($(hoverElement).attr('id'));
				
			//});

		});
	}
</script>