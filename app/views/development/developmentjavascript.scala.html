<script type="text/javascript" >
	$(document).ready(function(){

		mouseCheck();
		
		$(document).on('click', '.btn-success', function(event){
	
	    	var name = $('#name').val();
	    	var title = $('#title').val();
	    	var description = $('#description').val();
	    	//alert( name + title + description );
	    	
	    	var route = r = jsRoutes.controllers.Development.validatePage(name).ajax({
	    		beforeSend: function() {
	    			$('#modalNew').find('.modal-loading').show();
	    			$('#modalNew').find('.modal-form').hide();
	    		},
	    		success: 	function(data) {
					if (data != null && data != '')
					{
						$('#modalNew').find('.modal-error').css('padding-left', '15px');
						$('#modalNew').find('.modal-error').css('padding-right', '15px');
						$('#modalNew').find('.modal-error').html("<div class='alert alert-danger'>" + data + "</div>");
		    			$('#modalNew').find('.modal-loading').hide();
		    			$('#modalNew').find('.modal-form').show();
					}
					else
					{
				    	jsRoutes.controllers.Development.addPage(name, title, description).ajax({
							success: function(data) {
					    		window.location.replace("/development/" + name);
						  	},
						  	error: function() {
				    			$('#modalNew').find('.modal-loading').hide();
				    			$('#modalNew').find('.modal-form').show();						  		
						    	alert("Error!");
						  	}
						});
					}
				},
				error:		function(){

					var error;
					if (!name)
					{
						error = "You must enter a name."
					}
					
					$('#modalNew').find('.modal-error').css('padding-left', '15px');
					$('#modalNew').find('.modal-error').css('padding-right', '15px');
					$('#modalNew').find('.modal-error').html("<div class='alert alert-danger'>" + error + "</div>");
	    			$('#modalNew').find('.modal-loading').hide();
	    			$('#modalNew').find('.modal-form').show();
					
				}
	    	});
		});

		$('#modalNew').on('hidden.bs.modal', function () {
			  // do something…
			  $('#modalNew').find('.modal-error').empty();
		});
	
		$(document).on('click', '#open-menu', function(event){
	
	    	jsRoutes.controllers.Development.openMenu().ajax({
	    		success: function(data) {
					//alert(data);
					
					$('#open-result').html(data);			    				    	
			  	},
			  	error: function() {
			    	alert("Error!")
			  	}
			});
	    	
		});

	    $('input[type=file]').change(function() {
			var file = this.files[0];
			uploadFile(file);
	    });
	
		if (Modernizr.draganddrop) 
		{
			// Browser supports HTML5 DnD.
		  	//alert("drag and drop");
		} 
		else 
		{
		  	// Fallback to a library solution.
			//alert("no drag and drop");
		}
		
  		// Setup the dnd listeners.
  		var dropZone = document.getElementById('drop-zone');
  		dropZone.addEventListener('dragover', handleDragOver, false);
  		dropZone.addEventListener('drop', handleFileSelect, false);

		mediaThumbnails();

    	hidePanelMenu();

		setDroppable();
		
		//draggableTemplate();
		
		editText();
		deleteComponent();			
	});
	
	//Functions
    function uploadFile(file)
    {
		//this only uploads raw file
    	jsRoutes.controllers.Development.uploadAjax(file.name).ajax({
	    	data: file,
	    	processData: false,
            contentType: false,
            cache: false,
            type: 'POST',
			success: function(data) {
				mediaThumbnails();
		  	},
		  	error: function() {
		    	alert("Error!");
		  	}
		});	    
    }
	
	function mediaThumbnails(){
		jsRoutes.controllers.Development.showImageThumbnails("medium").ajax({
			success: function(data) {
				//alert(data);
		    	$('#media-thumbnails').html(data);
		    	draggableThumbnail();
		    	hidePanelMenu();		    	
		  	},
		  	error: function() {
		    	alert("Error!");
		  	}
		});
	}

	function hidePanelMenu()
	{
    	$('.panel').each(function(){
			$(this).find('.component-menu').addClass('hide');
		});
	}

	function deleteComponent()
	{
		$('.delete-component').click(function(){

			if ($(this).closest('.component-element').attr('id'))
			{
				var elementId = $(this).closest('.component-element').attr('id');
				
				jsRoutes.controllers.Development.deleteComponent(elementId).ajax({
					success: function(data)
					{
						//alert("worked");
					},
					error: function()
					{
						alert("Error!");
					}
				});
				
				$(this).closest('.component-element').remove();
			}

		});
	}
	
	function getCode(element, type)
	{
		var code = "";
		var codeElement = $(element).clone();
		
		$(codeElement).find('.component-menu').remove();
		$(codeElement).find('.component-interior').replaceWith($(codeElement).find('.component-interior').html());

		switch (type.toLowerCase())
		{
			case "row":
			{
				
			}
			case "column":
			{
				break;
			}
			default:
			{

				code = $(codeElement).html();
			}
		}

		return code;
	}

	function updateComponent(element)
	{				
		var childIds = [];
		var componentType = $(element).attr('type');
		var classes = $(element).attr('class');
		var code = "";
		var componentId = 0;
		var displayOrder = $(element).index();
		
		var parent = $(element).parent().closest('.component-element, .custom-page');
		var parentId = $(parent).attr('id');

		var codeElement = $(element).clone();

		$(element).find('.thumbnail-component').remove();
		$(element).find(".hide").removeClass('hide');
		$(element).find('.editable-text').attr('contentEditable', 'false');

		if ($(element).attr('id'))
		{
			componentId = $(element).attr('id');
		}

		code = getCode(element, componentType);



		jsRoutes.controllers.Development.updateComponent(componentId, parentId, componentType, classes, code, displayOrder).ajax({
			async: false,
			success: function(data) 
			{
	    		componentId = data;					    											    						    	
		  	},
		  	error: function() 
		  	{
		    	alert("Error!");
		  	}
		});				
		
		$(element).attr('id', componentId);
		
		$(element).find('.component-element').each(function(index, value)
		{
			childIds.push( updateComponent(value) );
		});

		editText();
		deleteComponent();	
		
		return componentId;		
	}

	function updateOrder(element)
	{
		var parentId = $(element).attr('id');
		var order = $(element).sortable('toArray');

		jsRoutes.controllers.Development.updateOrder(parentId, order).ajax({
			async: false,
			success: function(data) 
			{
		  	},
		  	error: function() 
		  	{
		    	alert("Error!");
		  	}
		});		
	}
	
	function setDroppable()
	{
		var element;
		
		$(".custom-page, .custom-page .column").sortable({
			placeholder: "placeholder-element",
	        connectWith: ".column",
            revert:			true,
	        opacity: .50,
	        handle: ".drag",
	        tolerance: "pointer",
	        beforeStop: function(event, ui)
	        {
	        	element = ui.item;
	        },
	        receive: function(event, ui)
	        {
	        	updateComponent(element);
	        },
	        update: function(event, ui)
	        {
	        	if (this === ui.item.parent()[0]) 
	        	{
		        	updateOrder(this);
		        	editText();
				}
	        },
	        start: function (event, ui)
	        {
	        	$(ui.item).appendTo(this).addClass("dragging");
	        },
	        stop: function (event, ui)
	        {
	        	$(ui.item).removeClass("dragging");
	        }
	    });
	    $(".sidebar-nav .component-wrapper").draggable({
	        connectToSortable: ".custom-page",
	        //handle: ".drag",
    	    helper: function (event)
	        {
				var clonedElement = $(this).clone();

				$(clonedElement).find('.thumbnail-component').remove();
				$(clonedElement).find(".hide").removeClass('hide');
				
				return clonedElement;
	        },
	        start: function (event, ui)
	        {
	        	
	        },
	        stop: function (event, ui) 
	        {
	        	
	            $(".custom-page .column").sortable({
	    			placeholder: "placeholder-element",
	    	        connectWith: ".column",
	    	        opacity: .50,
	    	        handle: ".drag",
	    	        beforeStop: function(event, ui)
	    	        {
	    	        	element = ui.item;
	    	        },
	    	        receive: function(event, ui)
	    	        {
	    	        	updateComponent(element); 	        
    	        	},
    		        update: function(event, ui)
    		        {
    		        	if (this === ui.item.parent()[0]) 
       		        	{
    			        	updateOrder(this);
    			        	editText();
    					}
    		        },
    		        start: function (event, ui)
    		        {
    		        	$(ui.item).appendTo(this).addClass("dragging");
    		        },
    		        stop: function (event, ui)
    		        {
    		        	$(ui.item).removeClass("dragging");
    		        }
	            });
	        }
	    });
	    $(".sidebar-nav .design-element").draggable({
	        connectToSortable: ".column",
	        //handle: ".drag",
	        //helper: "clone",
    	    helper: function (event)
	        {
				var clonedElement = $(this).clone();

				$(clonedElement).find('.thumbnail-component').remove();
				$(clonedElement).find(".hide").removeClass('hide');
				//alert($(clonedElement).attr('class'));
				
				return clonedElement;
	        },	        
	        drag: function (event, ui) {
	            ui.helper.width(500)
	        }
	    });
	}
	
	function draggableThumbnail()
	{
        $('#media-thumbnails > .design-element').draggable({
        	connectToSortable: ".column",
            helper:			function(event){
				var result = $(this).clone();
				var img = $(result).find('img');

				$(result).find('.thumbnail-component').remove();
				$(result).find(".hide").removeClass('hide');			
            	
			 	jsRoutes.controllers.Development.getImage(img.attr('parentId'), "large").ajax({
					success: function(data) 
					{
						img.replaceWith(data);			    	
				  	},
				  	error: function() 
				  	{
				    	alert("Error!");
				  	}
				});
				
				return result;		            
            }

        });
    }
	
	function handleDragOver(event) 
	{
   		event.stopPropagation();
   		event.preventDefault();
   		event.dataTransfer.dropEffect = 'copy'; // Explicitly show this is a copy.
	}
		
	function handleFileSelect(event) 
	{
		event.stopPropagation();
  		event.preventDefault();

  		var files = event.dataTransfer.files; // FileList object.

  		// files is a FileList of File objects. List some properties.
  		
  		var output = [];
  		
  		for (var i = 0, f; f = files[i]; i++) 
  		{
   			uploadFile(f);
   			
   			output.push('<li><strong>', escape(f.name), '</strong> (', f.type || 'n/a', ') - ',
         			f.size, ' bytes, last modified: ',
               	f.lastModifiedDate ? f.lastModifiedDate.toLocaleDateString() : 'n/a',
               	'</li>');
		}
 			
  		document.getElementById('list').innerHTML = '<ul>' + output.join('') + '</ul>';
	}

	
	function editText()
	{
		var currentVal = "";

		$('.editable-text').attr('contentEditable', 'true');
		
		
		$('.editable-text').popline();

		$('.editable-text').focusin(function() 
		{
			currentVal = $(this).html();
		});
						
		
		$('.editable-text').off('blur').on('blur', function() 
		{
			if ($(this).closest('.ui-draggable').attr('id') && $(this).html() != currentVal)
			{
				updateComponent($(this).closest('.ui-draggable'));
			}
		});		
		

	}

	function mouseCheck()
	{
		$('*').on('mouseenter', function() { 
			var hoverElement = this; 
			var navElement = $(hoverElement).children('div.component-wrapper > ul.nav');
			//$(hoverElement).find('div.component-wrapper > ul.nav').each(function()
			//{
				//alert("PHIL TEST");
				//$(hoverElement).append("test").stop();
				
				//$('#test-msg').html($(hoverElement).attr('id'));
				
			//});

		});
	}
</script>